<div class="card">
    <h2>Swarm</h2>

    <ng-container *ngIf="swarm.length; else empty">
        <div class="grid">
            <div class="col-6 xl:col-3" *ngFor="let metric of [
                { label: 'Total Devices', value: swarm.length },
                { label: 'Total Hashrate', value: totals.hashRate * 1000000000 | hashSuffix},
                { label: 'Total Power', value: (totals.power | number: '1.1-1')  + ' W' },
                { label: 'Best Diff', value: totals.bestDiff }
            ]">
                <div class="card flex flex-column mb-0">
                    <span class="text-500 font-medium mb-3">{{metric.label}}</span>
                    <div class="text-900 font-medium text-2xl">{{metric.value}}</div>
                </div>
            </div>
        </div>

        <div class="card mt-2 overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr>
                        <th *ngFor="let field of [
                            { label: 'Hostname', name: 'hostname' },
                            { label: 'IP', name: 'IP' },
                            { label: 'Hashrate', name: 'hashRate' },
                            { label: 'Shares', name: 'sharesAccepted' },
                            { label: 'Best Diff', name: 'bestDiff' },
                            { label: 'Uptime', name: 'uptimeSeconds' },
                            { label: 'Power', name: 'power' },
                            { label: 'Temp', name: 'temp' },
                            { label: 'Pool Diff', name: 'poolDifficulty' },
                            { label: 'Version', name: 'version' },
                        ]" class="text-500 font-medium">
                            <div class="flex align-items-center cursor-pointer select-none relative" (click)="sortBy(field.name)">
                                <span class="pr-3">{{field.label}}</span>
                                <i class="pi text-xs absolute right-0" [ngClass]="{
                                    'pi-sort-up-fill': sortField === field.name && sortDirection === 'asc',
                                    'pi-sort-down-fill': sortField === field.name && sortDirection === 'desc'
                                }"></i>
                            </div>
                        </th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let axe of swarm">
                        <td>
                            <a [href]="'http://' + axe.IP" target="_blank" [ngStyle]="{color: axe.swarmColor}">
                                {{axe.hostname}}
                            </a>
                        </td>
                        <td>
                            <a [href]="'http://' + axe.IP" target="_blank" class="text-900">{{axe.IP}}</a>
                        </td>
                        <td>{{axe.hashRate * 1000000000 | hashSuffix}}</td>
                        <td>
                            <p class="cursor-pointer m-0" pTooltip="Shares Accepted" tooltipPosition="top">
                                {{axe.sharesAccepted | number: '1.0-0'}}
                            </p>
                            <p class="text-500 cursor-pointer m-0" pTooltip="Shares Rejected" tooltipPosition="top">
                                {{axe.sharesRejected | number: '1.0-0'}}
                            </p>
                        </td>
                        <td>
                            <p class="cursor-pointer m-0" pTooltip="Best Diff" tooltipPosition="top">
                                {{axe.bestDiff}}
                            </p>
                            <p class="text-500 cursor-pointer m-0" pTooltip="Best Session Diff" tooltipPosition="top">
                                {{axe.bestSessionDiff}}
                            </p>
                        </td>
                        <td class="cursor-pointer" pTooltip="{{axe.uptimeSeconds | dateAgo}}" tooltipPosition="top">
                            {{axe.uptimeSeconds | dateAgo: {intervals: 1} }}
                        </td>
                        <td>{{axe.power | number: '1.1-1'}} W</td>
                        <td>
                            <p class="cursor-pointer m-0" [ngClass]="{'text-orange-500': axe.temp > 68}" pTooltip="ASIC Temperature" tooltipPosition="top">
                                {{axe.temp | number: '1.0-1'}} °C
                            </p>
                            <p class="text-500 cursor-pointer m-0" *ngIf="axe.vrTemp" [ngClass]="{'text-orange-500': axe.vrTemp > 90}" pTooltip="Voltage Regulator Temperature" tooltipPosition="top">
                                {{axe.vrTemp | number: '1.0-1'}} °C
                            </p>
                        </td>
                        <td>{{axe.poolDifficulty}}</td>
                        <td>{{axe.version}}</td>
                        <td>
                            <p-button
                                icon="pi pi-pencil flex align-items-center justify-content-center"
                                pp-button
                                severity="secondary"
                                styleClass="button-icon"
                                (click)="edit(axe)" />
                            <p-button
                                icon="pi pi-refresh flex align-items-center justify-content-center"
                                pp-button
                                severity="secondary"
                                styleClass="button-icon"
                                class="mx-2"
                                (click)="restart(axe)" />
                            <p-button
                                icon="pi pi-trash flex align-items-center justify-content-center"
                                pp-button
                                severity="secondary"
                                styleClass="button-icon"
                                (click)="remove(axe)" />
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="flex flex-wrap gap-2 mt-3 text-sm justify-content-center">
            <div *ngFor="let item of deviceFamilies" class="flex align-items-center gap-1">
                <span [ngStyle]="{color: item.swarmColor}">●</span>
                <span>{{ item.deviceModel || 'Other' }} ({{ item.asicCount > 1 ? item.asicCount + 'x ' : '' }}{{ item.ASICModel }})</span>
            </div>
        </div>
    </ng-container>

    <ng-template #empty>
        <p class="text-500 text-center pt-5">
            Scan your network for devices or add a device manually by using its IP address.
        </p>
    </ng-template>

    <form *ngIf="form" [formGroup]="form" class="card flex flex-column md:flex-row gap-3 mt-5">
        <button pButton (click)="scanNetwork()" [disabled]="scanning" class="white-space-nowrap w-full md:w-auto block text-center button-text">
            {{scanning ? 'Scanning...' : 'Auto Scan'}}
        </button>

        <div class="flex align-items-center gap-3" *ngIf="this.swarm.length">
            <button pButton (click)="refreshList()" class="flex justify-content-between button-text">
                <span>{{isRefreshing ? 'Refreshing...' : 'Refresh'}}</span>
                <span *ngIf="!isRefreshing" class="text-sm text-700">{{refreshIntervalTime}}</span>
            </button>
            <div class="flex flex-grow-1 align-items-center gap-3">
                <p-slider class="w-full md:w-3rem xl:w-6rem" [min]="5" [max]="30" [formControl]="refreshIntervalControl"></p-slider>
                <span class="text-sm white-space-nowrap">{{refreshTimeSet}} s</span>
            </div>
        </div>

        <div class="md:ml-auto">
            <p-inputGroup>
                <input pInputText placeholder="Add Device by IP" formControlName="manualAddIp" type="text" class="xl:w-20rem" />
                <button pButton [disabled]="form.invalid" (click)="add()" class="ml-1">Add</button>
            </p-inputGroup>
        </div>
    </form>

    <app-modal [headline]="selectedAxeOs?.IP">
        <app-edit *ngIf="selectedAxeOs" [uri]="'http://' + selectedAxeOs.IP"></app-edit>
    </app-modal>
</div>